<%#= content_for :content_title do "Thanks #{@user.forename.strip}, here's your conveyancing quote" end %>
<% costs = ConveyancingCalculator.configuration.additional_costs[current_user.symbolised_location].reduce(Hash.new, :merge) %>

<%= content_for :javascript do %>
  <script>
    $(document).on('click', '.conveyancing-cost__toggle', function() {
      let $formId = $('#' + $(this).data('id'));

      $formId.click();

      $(this).addClass('conveyancing-cost__toggle--hidden');
      $(this).siblings().removeClass('conveyancing-cost__toggle--hidden');

      let $closestForm = $(this).closest('form')

      $closestForm.submit();
      $closestForm.parent()
                  .find('.conveyancing-breakdown__sub-total-overview span')
                  .html('<div class="loader" />');

      return false;
    });
  </script>
<% end %>

<div class="conveyancing-content">
  <div class="conveyancing-content__section conveyancing-content__section--full">
    <nav class="conveyancing-navigation">
      <ol class="conveyancing-navigation-breadcrumbs">
        <li class="conveyancing-navigation-breadcrumbs__item">
          <div class="conveyancing-navigation-breadcrumbs__breadcrumb conveyancing-navigation-breadcrumbs__breadcrumb--complete">
            <div class="conveyancing-navigation-breadcrumbs__icon conveyancing-navigation-breadcrumbs__icon--complete">
              <%= render partial: 'conveyancing_quotes/shared/svgs/checkmark' %>
            </div>

            <div class="conveyancing-navigation-breadcrumbs__title">
              Step 1
            </div>

            <div class="conveyancing-navigation-breadcrumbs__microcopy">
              Your details
            </div>
          </div>
        </li>

        <li class="conveyancing-navigation-breadcrumbs__item">
          <div class="conveyancing-navigation-breadcrumbs__breadcrumb conveyancing-navigation-breadcrumbs__breadcrumb--complete">
            <div class="conveyancing-navigation-breadcrumbs__icon conveyancing-navigation-breadcrumbs__icon--current">

            </div>

            <div class="conveyancing-navigation-breadcrumbs__title conveyancing-navigation-breadcrumbs__title--current">
              Step 2
            </div>

            <div class="conveyancing-navigation-breadcrumbs__microcopy">
              Your results
            </div>
          </div>
        </li>

        <li class="conveyancing-navigation-breadcrumbs__item">
          <div class="conveyancing-navigation-breadcrumbs__breadcrumb conveyancing-navigation-breadcrumbs__breadcrumb--complete">
            <div class="conveyancing-navigation-breadcrumbs__icon conveyancing-navigation-breadcrumbs__icon--incomplete">

            </div>

            <div class="conveyancing-navigation-breadcrumbs__title">
              Step 3
            </div>

            <div class="conveyancing-navigation-breadcrumbs__microcopy">
              Instruct us
            </div>
          </div>
        </li>
      </ol>
    </nav>

    <h1 class="conveyancing-content__main-title">
      Here is your fixed price quote based on
      <% if @user.purchase.present? %>
        your buying price of <strong><%= number_to_currency @user.purchase.price %></strong>
      <% end %>
      <% if @user.purchase.present? && @user.sale.present? %>
        and
      <% end %>
      <% if @user.sale.present? %>
        your selling price of <strong><%= number_to_currency @user.sale.price %></strong>
      <% end %>
    </h1>

    <p class="conveyancing-content__microcopy">
      Your quote reference is:
      <strong>
        <%= @user.quote_reference %>
      </strong>
    </p>

    <div class="conveyancing-scroll-arrow">
      <%= link_to '#pay-us',
                  class: 'conveyancing-scroll-arrow__shape conveyancing-scroll-arrow__shape--bounce' do %>
      <% end %>
      Scroll for more
    </div>
  </div>
</div>

<section class="conveyancing-breakdown">
  <header class="conveyancing-breakdown__header conveyancing-breakdown__header--first">
    <h1 class="conveyancing-breakdown__main-title">
      What you pay <span class="conveyancing-breakdown__emphasis">us</span>
      for our services
    </h1>
  </header>

  <div class="conveyancing-breakdown__details">
    <%= render 'conveyancing_quotes/purchases/shared/conveyancing_costs',
               purchase: @user.purchase if @user.purchase.present? %>
    <%= render 'conveyancing_quotes/sales/shared/conveyancing_costs',
               sale: @user.sale if @user.sale.present? %>

    <footer class="conveyancing-breakdown__sub-total-overview">
      Sub-total

      <div class="conveyancing-breakdown__sub-total">
        <% sub_total = 0 %>
        <% sub_total += @user.sale.fee if @user.sale.present? %>
        <% sub_total += @user.purchase.fee if @user.purchase.present? %>
        <%= number_to_currency sub_total %>
      </div>
    </footer>
  </div>
</section>

<section class="conveyancing-breakdown">
  <header class="conveyancing-breakdown__header conveyancing-breakdown__header--second">
    <h1 class="conveyancing-breakdown__main-title">
      Optional extras
    </h1>
  </header>

  <div class="conveyancing-breakdown__details">
    <% if @user.selling.present? %>
      <div>
        <h2 class="conveyancing-breakdown__title">
          For Selling
        </h2>

        <%= form_for @user.sale, url: conveyancing_quotes_sales_path, remote: true do |f| %>
          <%= render 'conveyancing_quotes/sales/shared/optional_extras',
                    f: f,
                    costs: costs %>
        <% end %>

        <div class="conveyancing-breakdown__sub-total-overview">
        Sub-total

          <div class="conveyancing-breakdown__sub-total">
            <% sub_total = 0 %>
            <% @user.sale.additional_costs.each do |additional_cost| %>
              <% sub_total += costs[additional_cost] %>
            <% end %>
            <span class="conveyancing-breakdown__sub-total-sale">
              <%= number_to_currency sub_total %>
            </span>
          </div>
        </div>
      </div>
    <% end %>


    <% if @user.purchase.present? %>
      <div>
        <h2 class="conveyancing-breakdown__title">
          For Buying
        </h2>

        <%= form_for @user.purchase, url: conveyancing_quotes_purchases_path, remote: true do |f| %>
          <%= render 'conveyancing_quotes/purchases/shared/optional_extras',
                    f: f,
                    costs: costs %>
        <% end %>

        <div class="conveyancing-breakdown__sub-total-overview">
        Sub-total

          <div class="conveyancing-breakdown__sub-total">
            <% sub_total = 0 %>
            <% @user.purchase.additional_costs.each do |additional_cost| %>
              <% sub_total += costs[additional_cost] %>
            <% end %>
            <span class="conveyancing-breakdown__sub-total-purchase">
              <%= number_to_currency sub_total %>
            </span>
          </div>
        </div>
      </div>
  <% end %>
  </div>
</section>

<section class="conveyancing-breakdown">
  <header class="conveyancing-breakdown__header conveyancing-breakdown__header--third">
    <h1 class="conveyancing-breakdown__main-title">
      Additional costs paid to
      <span class="conveyancing-breakdown__emphasis">third parties</span>
    </h1>
  </header>

  <div class="conveyancing-breakdown__details">
    <% if @user.purchase.present? %>
      <div>
        <h2 class="conveyancing-breakdown__title">
          For Buying
        </h2>

        <div class="conveyancing-breakdown__additional-costs
                    conveyancing-breakdown__additional-costs--purchase">
          <%= render 'conveyancing_quotes/purchases/shared/additional_costs',
                    costs: costs,
                    purchase: @user.purchase %>
        </div>
      </div>
  <% end %>
    <% if @user.sale.present? %>
      <div>
        <h2 class="conveyancing-breakdown__title">
          For Selling
        </h2>

        <%= render 'conveyancing_quotes/sales/shared/additional_costs',
                  costs: costs,
                  sale: @user.sale %>
      </div>
  <% end %>
  </div>
</section>

<section class="conveyancing-breakdown">
  <div class="conveyancing-content__section
              conveyancing-content__section--cta
              conveyancing-content__section--full">
    <%= render @user.sale if @user.sale.present? %>
    <%= render @user.purchase if @user.purchase.present? %>

    <%= link_to '#' do %>
      Email me with this quote
    <% end %>

    <p>
      Your quote is valid for 30 days and fully inclusive, fixed price*
    </p>
  </div>
</section>

<%#= render @user.purchase if @user.purchase.present? %>


<div class="conveyancing-quote-overview">
  <h3>Proceed with Quote</h3>
  <p>If you are happy with the quote, please proceed to accept it.</p>
  <%= link_to 'Accept quote', new_conveyancing_quotes_deeds_path, class: 'inverted-submit-button ga-event', data: { event_category: 'Conveyancing Calculator', event_action: 'Accept Quote', event_label: 'Accept Quote' } %>
  <%= link_to 'Print quote', '#', class: 'inverted-submit-button print-page ga-event', data: { event_category: 'Conveyancing Calculator', event_action: 'Print Quote', event_label: 'Print Quote' } %>

  <h4>Request More Information</h4>

  <p>
    Call:
    <%= render 'shared/calltracks_phone',
                phone: global_site_settings['Phone'],
                options: { class: 'inverted-submit-button' } %>

    <%= link_to 'Request a callback',
                '#',
                class: 'inverted-submit-button toggle-class',
                data: {
                  class: 'visible',
                  container: '.remote-callback-request-form-modal',
                  return: false
                  }  %>
    <%= link_to 'Email us',
                '#',
                class: 'inverted-submit-button toggle-class',
                data: {
                  class: 'visible',
                  container: '.remote-contact-form-modal',
                  return: false
                  }  %>

  </p>
</div>
